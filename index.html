<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Budget Avancée</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Ajout de la bibliothèque Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
        }
        /* Style pour une scrollbar plus discrète */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 8px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .action-icon { cursor: pointer; transition: transform 0.2s ease-in-out, color 0.2s ease-in-out; }
        .action-icon:hover { transform: scale(1.2); }
        .excel-table td, .excel-table th { border: 1px solid #e2e8f0; padding: 10px 12px; vertical-align: middle; }
        .summary-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .summary-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-gradient { background-image: linear-gradient(to right, #4facfe 0%, #00f2fe 100%); transition: all 0.3s ease; background-size: 200% auto; }
        .btn-gradient:hover { background-position: right center; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        /* --- NOUVEAUX STYLES POUR LA CALCULATRICE ET LES OUTILS --- */
        .calculator-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .calculator-modal-overlay.active { opacity: 1; pointer-events: auto; }
        .calculator {
            background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 320px; transform: scale(0.95); transition: transform 0.3s ease;
        }
        .calculator-modal-overlay.active .calculator { transform: scale(1); }
        .calculator-screen {
            width: 100%; background: #f3f4f6; border-radius: 8px; padding: 15px 20px;
            font-size: 2.5rem; text-align: right; font-weight: 700; color: #1f2937;
            margin-bottom: 20px; border: 1px solid #e5e7eb; overflow-x: auto; white-space: nowrap;
        }
        .calculator-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .calculator-key {
            padding: 20px 0; font-size: 1.2rem; font-weight: 600; border-radius: 8px;
            border: none; background: #f9fafb; color: #374151;
            cursor: pointer; transition: background-color 0.2s, transform 0.1s; border: 1px solid #e5e7eb;
        }
        .calculator-key:active { transform: scale(0.95); }
        .calculator-key:hover { background: #f3f4f6; }
        .calculator-key.operator { background-color: #fef3c7; color: #92400e; }
        .calculator-key.equal-sign { background-color: #4facfe; color: white; grid-column: span 2; }
        .calculator-key.clear { background-color: #fee2e2; color: #b91c1c; }
        .floating-btn {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; border-radius: 50%;
            background-image: linear-gradient(to right, #60a5fa 0%, #3b82f6 100%);
            color: white; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer;
            z-index: 40; transition: transform 0.2s ease;
        }
        .floating-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body class="text-gray-700">
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- En-tête -->
        <header class="text-center mb-10 fade-in">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 tracking-tight">
                Gestion d'Argent Personnelle
            </h1>
            <p class="text-gray-500 mt-3 text-lg">Suivez et optimisez vos finances en toute simplicité</p>
        </header>
        
        <div id="user-info" class="text-center mb-4 p-2 bg-blue-100 text-blue-800 rounded-lg hidden">
            Connecté en tant que: <span id="user-id" class="font-bold"></span>
        </div>

        <!-- Section des résumés -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 summary-card fade-in" style="animation-delay: 0.1s;">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-500">Revenu Total</h2>
                    <div class="bg-green-100 rounded-full p-2">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16h10M7 12h.01M17 12h.01M7 8h.01M17 8h.01"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 4h14a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2z"></path></svg>
                    </div>
                </div>
                <p id="total-income" class="text-3xl font-bold text-green-600 mt-2">¥0</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 summary-card fade-in" style="animation-delay: 0.2s;">
                 <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-500">Dépense Totale</h2>
                    <div class="bg-red-100 rounded-full p-2">
                       <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    </div>
                </div>
                <p id="total-expense" class="text-3xl font-bold text-red-600 mt-2">¥0</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 summary-card fade-in" style="animation-delay: 0.3s;">
                 <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-500">Solde</h2>
                    <div class="bg-blue-100 rounded-full p-2">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0 0l-6 2m6 2v10m6-10v10"></path></svg>
                    </div>
                </div>
                <p id="balance" class="text-3xl font-bold text-gray-800 mt-2">¥0</p>
            </div>
        </div>

        <!-- Layout principal -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-3">
                <!-- Formulaire d'ajout/modification de transaction -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8 fade-in" style="animation-delay: 0.4s;">
                    <h3 id="form-title" class="text-xl font-bold mb-4 text-gray-800">Ajouter une Transaction</h3>
                    <form id="transaction-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <input type="hidden" id="transaction-id">
                        <div class="sm:col-span-2">
                            <label for="description" class="block text-sm font-medium text-gray-600 mb-1">Description</label>
                            <input id="description" placeholder="Ex: Salaire, Loyer, Nourriture..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required autocomplete="off">
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-600 mb-1">Montant</label>
                            <input type="number" id="amount" placeholder="¥" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="startDate" class="block text-sm font-medium text-gray-600 mb-1">Date</label>
                            <input type="date" id="startDate" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                             <label for="category" class="block text-sm font-medium text-gray-600 mb-1">Catégorie</label>
                             <select id="category" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Sélectionner une catégorie</option>
                                <option value="Revenu">Revenu</option>
                                <option value="Logement">Logement</option>
                                <option value="Transport">Transport</option>
                                <option value="Alimentation">Alimentation</option>
                                <option value="Loisirs">Loisirs</option>
                                <option value="Santé">Santé</option>
                                <option value="Dettes">Dettes</option>
                                <option value="Épargne">Épargne</option>
                                <option value="Autre">Autre</option>
                             </select>
                        </div>
                        <div>
                            <label for="type" class="block text-sm font-medium text-gray-600 mb-1">Type</label>
                            <select id="type" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="income">Revenu</option>
                                <option value="expense" selected>Dépense</option>
                            </select>
                        </div>
                        <div class="sm:col-span-2">
                             <button type="submit" id="submit-btn" class="w-full btn-gradient text-white font-bold py-3 px-4 rounded-lg hover:shadow-lg transition-shadow">Ajouter</button>
                             <button type="button" id="cancel-edit-btn" class="w-full mt-2 bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors hidden">Annuler</button>
                        </div>
                    </form>
                </div>

                <!-- Historique des transactions -->
                <div class="mt-8 fade-in" style="animation-delay: 0.5s;">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="text-xl font-bold text-gray-800">Historique des Transactions</h3>
                        <div class="flex items-center gap-2">
                           <select id="filter" class="p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">Tout</option>
                                <option value="income">Revenus</option>
                                <option value="expense">Dépenses</option>
                            </select>
                            <button id="delete-all-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                Tout Supprimer
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-xl shadow-lg border border-gray-200">
                        <div class="hidden md:grid md:grid-cols-5 gap-4 p-4 font-bold text-left text-gray-600 border-b-2 border-gray-200 bg-gray-50">
                            <div>Date</div>
                            <div>Description</div>
                            <div>Catégorie</div>
                            <div class="text-right">Montant</div>
                            <div class="text-center">Actions</div>
                        </div>
                        <div id="transaction-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOUVELLE SECTION: Visualisation et Outils -->
        <div class="mt-10 grid grid-cols-1 lg:grid-cols-5 gap-8 fade-in" style="animation-delay: 0.6s;">
            <!-- Graphique des dépenses -->
            <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h3 class="text-xl font-bold text-center mb-4 text-gray-800">Répartition des Dépenses</h3>
                <div id="chart-container" class="relative h-72 md:h-80 flex justify-center items-center">
                    <canvas id="expenseChart"></canvas>
                    <p id="no-expense-data" class="text-gray-500 hidden">Aucune dépense à visualiser.</p>
                </div>
            </div>
            <!-- Outil à venir -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200 flex flex-col justify-center items-center">
                 <h3 class="text-xl font-bold text-center mb-4 text-gray-800">Outils d'Optimisation</h3>
                 <div class="text-center">
                    <svg class="w-16 h-16 mx-auto text-blue-200 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3M5.636 5.636l1.414 1.414m10.304 10.304l1.414 1.414M5.636 18.364l1.414-1.414m10.304-10.304l1.414-1.414"></path></svg>
                    <p class="text-gray-600">Un outil de planification de dettes et d'objectifs d'épargne sera bientôt disponible !</p>
                 </div>
            </div>
        </div>

        <!-- Tableau de bord -->
        <div class="mt-10 fade-in" style="animation-delay: 0.7s;">
             <div class="flex justify-end mb-4">
                 <button id="download-btn" class="bg-green-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2 shadow hover:shadow-lg">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Télécharger
                 </button>
             </div>
            <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200" id="dashboard-container">
                 <h3 class="text-xl font-bold text-center mb-4 text-gray-800">Tableau de Bord Mensuel</h3>
                 <div class="overflow-x-auto">
                    <table class="w-full text-sm excel-table">
                        <thead>
                            <tr>
                                <th class="bg-gray-800 text-white font-semibold">Catégorie</th>
                                <th class="bg-gray-800 text-white font-semibold">Description</th>
                                <th class="bg-green-600 text-white font-semibold">Revenu</th>
                                <th class="bg-red-600 text-white font-semibold">Dépense</th>
                            </tr>
                        </thead>
                        <tbody id="excel-table-body"></tbody>
                         <tfoot>
                            <tr class="font-bold bg-gray-100">
                                <td colspan="2" class="text-right">TOTAL</td>
                                <td id="excel-total-income" class="text-green-700 text-right">¥0</td>
                                <td id="excel-total-expense" class="text-red-700 text-right">¥0</td>
                            </tr>
                            <tr class="font-bold bg-gray-200 text-lg">
                                <td colspan="3" class="text-right">SOLDE FINAL</td>
                                <td id="excel-final-balance" class="text-gray-800 text-right">¥0</td>
                            </tr>
                        </tfoot>
                    </table>
                 </div>
            </div>
        </div>
    </div>

    <!-- NOUVEAU: Bouton flottant pour la calculatrice -->
    <div id="open-calculator-btn" class="floating-btn">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m-3 10v-6m-6 3h12a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
    </div>

    <!-- NOUVEAU: Fenêtre modale de la calculatrice -->
    <div id="calculator-modal" class="calculator-modal-overlay">
        <div class="calculator">
            <div id="calculator-screen" class="calculator-screen">0</div>
            <div class="calculator-keys">
                <button type="button" class="calculator-key clear" value="clear">C</button>
                <button type="button" class="calculator-key operator" value="/">&divide;</button>
                <button type="button" class="calculator-key operator" value="*">&times;</button>
                <button type="button" class="calculator-key" value="backspace">⌫</button>

                <button type="button" class="calculator-key" value="7">7</button>
                <button type="button" class="calculator-key" value="8">8</button>
                <button type="button" class="calculator-key" value="9">9</button>
                <button type="button" class="calculator-key operator" value="-">-</button>

                <button type="button" class="calculator-key" value="4">4</button>
                <button type="button" class="calculator-key" value="5">5</button>
                <button type="button" class="calculator-key" value="6">6</button>
                <button type="button" class="calculator-key operator" value="+">+</button>
                
                <button type="button" class="calculator-key" value="1">1</button>
                <button type="button" class="calculator-key" value="2">2</button>
                <button type="button" class="calculator-key" value="3">3</button>
                <button type="button" class="calculator-key equal-sign" value="=">=</button>
                
                <button type="button" class="calculator-key" value="0" style="grid-column: span 2">0</button>
                <button type="button" class="calculator-key" value=".">.</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- State & Config ---
        const today = new Date().toISOString().slice(0, 10);
        let transactions = [];
        let app, db, auth, userId, unsubscribe;
        let expenseChart; // Référence pour le graphique

        // --- DOM Elements ---
        const balanceEl = document.getElementById('balance'), totalIncomeEl = document.getElementById('total-income'), totalExpenseEl = document.getElementById('total-expense');
        const transactionListEl = document.getElementById('transaction-list'), form = document.getElementById('transaction-form'), descriptionEl = document.getElementById('description');
        const amountEl = document.getElementById('amount'), startDateEl = document.getElementById('startDate'), categoryEl = document.getElementById('category'), typeEl = document.getElementById('type');
        const transactionIdEl = document.getElementById('transaction-id'), formTitleEl = document.getElementById('form-title'), submitBtnEl = document.getElementById('submit-btn');
        const cancelEditBtnEl = document.getElementById('cancel-edit-btn'), filterEl = document.getElementById('filter'), deleteAllBtn = document.getElementById('delete-all-btn');
        const excelTableBody = document.getElementById('excel-table-body'), excelTotalIncome = document.getElementById('excel-total-income');
        const excelTotalExpense = document.getElementById('excel-total-expense'), excelFinalBalance = document.getElementById('excel-final-balance');
        const downloadBtn = document.getElementById('download-btn'), dashboardContainer = document.getElementById('dashboard-container');
        const userInfoEl = document.getElementById('user-info'), userIdEl = document.getElementById('user-id');
        const noExpenseDataEl = document.getElementById('no-expense-data');
        const categories = Array.from(categoryEl.options).map(opt => opt.value).filter(Boolean);

        // --- NOUVEAUX Éléments DOM ---
        const openCalculatorBtn = document.getElementById('open-calculator-btn');
        const calculatorModal = document.getElementById('calculator-modal');
        const calculatorScreen = document.getElementById('calculator-screen');
        const calculatorKeys = document.querySelector('.calculator-keys');

        // --- Utility Functions ---
        const saveDataToFirestore = async () => {
            if (!userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'budgets', 'data');
                await setDoc(docRef, { transactions: transactions });
            } catch (error) {
                console.error("Error saving data to Firestore: ", error);
            }
        };
        const generateID = () => Date.now() + Math.random();
        const formatCurrency = (amount) => new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(amount);
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('fr-CA');

        // --- Core Application Logic ---
        const render = () => {
            renderSummaryCards();
            renderTransactionList();
            renderExcelTable();
            renderExpenseChart();
        };
        const updateAndSave = () => { render(); saveDataToFirestore(); };

        // --- CRUD Handlers ---
        const handleFormSubmit = (e) => {
            e.preventDefault();
            const id = transactionIdEl.value ? Number(transactionIdEl.value) : null;
            if (!descriptionEl.value || amountEl.value === '' || !startDateEl.value || !categoryEl.value) return;
            const newTransaction = {
                id: id || generateID(),
                startDate: startDateEl.value,
                description: descriptionEl.value.trim(),
                amount: +amountEl.value,
                type: typeEl.value,
                category: categoryEl.value,
            };
            if (id) {
                transactions = transactions.map(t => t.id === id ? newTransaction : t);
            } else {
                transactions.push(newTransaction);
            }
            updateAndSave();
            resetForm();
        };
        window.deleteTransaction = (id) => { transactions = transactions.filter(t => t.id !== id); updateAndSave(); };
        const deleteAllTransactions = () => { transactions = []; updateAndSave(); };
        const handleDownloadImage = () => {
            html2canvas(dashboardContainer, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'tableau-de-bord-budget.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        };

        // --- UI Rendering ---
        const renderSummaryCards = () => {
            const income = transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            totalIncomeEl.textContent = formatCurrency(income);
            totalExpenseEl.textContent = formatCurrency(expense);
            balanceEl.textContent = formatCurrency(income - expense);
            balanceEl.classList.toggle('text-red-600', income - expense < 0);
        };
        const renderTransactionList = () => {
            transactionListEl.innerHTML = '';
            const filtered = transactions.filter(t => filterEl.value === 'all' || t.type === filterEl.value);
            if (filtered.length === 0) {
                transactionListEl.innerHTML = `<div class="p-6 text-center text-gray-500">Aucune transaction</div>`;
                return;
            }
            [...filtered].sort((a, b) => new Date(b.startDate) - new Date(a.startDate)).forEach(t => {
                const item = document.createElement('div');
                item.className = 'grid grid-cols-2 md:grid-cols-5 gap-x-4 gap-y-2 items-center p-4 border-b border-gray-100 last:border-b-0 hover:bg-gray-50';
                const isExpense = t.type === 'expense';
                item.innerHTML = `
                    <div class="text-gray-500 text-sm">${formatDate(t.startDate)}</div>
                    <div class="font-medium text-gray-800">${t.description}</div>
                    <div class="text-gray-500">${t.category}</div>
                    <div class="text-right font-semibold ${isExpense ? 'text-red-600' : 'text-green-600'} col-start-2 md:col-start-auto">
                        ${isExpense ? '-' : '+'}${formatCurrency(Math.abs(t.amount))}
                    </div>
                    <div class="col-span-2 md:col-span-1 flex justify-end md:justify-center items-center gap-3">
                        <svg onclick="window.editTransactionFlow(${t.id})" class="w-5 h-5 text-blue-500 action-icon hover:text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                        <svg onclick="window.deleteTransaction(${t.id})" class="w-5 h-5 text-red-500 action-icon hover:text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </div>
                `;
                transactionListEl.appendChild(item);
            });
        };
        const renderExcelTable = () => {
            excelTableBody.innerHTML = '';
             if (transactions.length === 0) {
                excelTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">Aucune donnée</td></tr>`;
                return;
            }
            const grouped = transactions.reduce((acc, t) => {
                acc[t.category] = acc[t.category] || [];
                acc[t.category].push(t);
                return acc;
            }, {});
            
            categories.forEach(category => {
                if (grouped[category]) {
                    grouped[category].forEach((t, i) => {
                        const row = excelTableBody.insertRow();
                        const isExpense = t.type === 'expense';
                        if (i === 0) {
                            const cell = row.insertCell();
                            cell.textContent = t.category;
                            cell.rowSpan = grouped[category].length;
                            cell.className = "font-semibold text-center align-middle";
                        }
                        row.insertCell().textContent = t.description;
                        row.insertCell().textContent = isExpense ? '' : formatCurrency(t.amount);
                        row.insertCell().textContent = isExpense ? formatCurrency(t.amount) : '';
                    });
                }
            });

            const totalIncome = transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const finalBalance = totalIncome - totalExpense;
            excelTotalIncome.textContent = formatCurrency(totalIncome);
            excelTotalExpense.textContent = formatCurrency(totalExpense);
            excelFinalBalance.textContent = formatCurrency(finalBalance);
        };
        
        // --- NOUVELLE FONCTION: Affichage du graphique ---
        const renderExpenseChart = () => {
            const expenseData = transactions.filter(t => t.type === 'expense');
            noExpenseDataEl.classList.toggle('hidden', expenseData.length > 0);
            if (expenseChart) expenseChart.destroy();
            if (expenseData.length === 0) return;

            const dataByCategory = expenseData.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});

            const ctx = document.getElementById('expenseChart').getContext('2d');
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataByCategory),
                    datasets: [{
                        data: Object.values(dataByCategory),
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6'],
                        borderColor: '#fff',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        };

        // --- Form Edit Flow ---
        window.editTransactionFlow = (id) => {
            const t = transactions.find(t => t.id === id);
            if (!t) return;
            transactionIdEl.value = t.id;
            descriptionEl.value = t.description;
            amountEl.value = t.amount;
            startDateEl.value = t.startDate;
            categoryEl.value = t.category;
            typeEl.value = t.type;

            formTitleEl.textContent = 'Modifier la Transaction';
            submitBtnEl.textContent = 'Mettre à jour';
            cancelEditBtnEl.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        const resetForm = () => {
            form.reset();
            transactionIdEl.value = '';
            startDateEl.value = today;
            typeEl.value = 'expense';
            formTitleEl.textContent = 'Ajouter une Transaction';
            submitBtnEl.textContent = 'Ajouter';
            cancelEditBtnEl.classList.add('hidden');
        };

        // --- NOUVEAU: Logique de la Calculatrice ---
        const calculator = { displayValue: '0', firstOperand: null, waitingForSecondOperand: false, operator: null };
        const updateDisplay = () => { calculatorScreen.textContent = calculator.displayValue.toLocaleString('en'); };
        const handleCalculatorInput = (e) => {
            const { target } = e;
            if (!target.matches('button')) return;
            const { value } = target;
            if (Number.isInteger(parseFloat(value))) inputDigit(value);
            else if (value === '.') inputDecimal();
            else if (value === 'clear') resetCalculator();
            else if (value === 'backspace') deleteLastDigit();
            else handleOperator(value);
            updateDisplay();
        };
        const inputDigit = (digit) => {
            if (calculator.waitingForSecondOperand) {
                calculator.displayValue = digit;
                calculator.waitingForSecondOperand = false;
            } else {
                calculator.displayValue = calculator.displayValue === '0' ? digit : calculator.displayValue + digit;
            }
        };
        const inputDecimal = () => { if (!calculator.displayValue.includes('.')) calculator.displayValue += '.'; };
        const resetCalculator = () => { Object.assign(calculator, { displayValue: '0', firstOperand: null, waitingForSecondOperand: false, operator: null }); };
        const deleteLastDigit = () => { calculator.displayValue = calculator.displayValue.slice(0, -1) || '0'; };
        const handleOperator = (nextOperator) => {
            const { firstOperand, displayValue, operator } = calculator;
            const inputValue = parseFloat(displayValue);
            if (operator && calculator.waitingForSecondOperand) { calculator.operator = nextOperator; return; }
            if (firstOperand === null && !isNaN(inputValue)) {
                calculator.firstOperand = inputValue;
            } else if (operator) {
                const result = calculate(firstOperand, inputValue, operator);
                calculator.displayValue = `${parseFloat(result.toFixed(7))}`;
                calculator.firstOperand = result;
            }
            calculator.waitingForSecondOperand = true;
            calculator.operator = nextOperator;
             if (nextOperator === '=') {
                calculator.waitingForSecondOperand = false;
                calculator.operator = null;
            }
        };
        const calculate = (a, b, op) => ({ '+': a + b, '-': a - b, '*': a * b, '/': a / b })[op] || b;

        // --- Initialisation ---
        const init = async () => {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            
            if (!firebaseConfig.projectId) {
                console.error("FirebaseError: 'projectId' not provided in firebase.initializeApp.");
                document.body.innerHTML = `<div class="text-red-600 text-center p-8">Erreur Critique: La configuration de Firebase est manquante. L'application ne peut pas démarrer.</div>`;
                return;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    userInfoEl.classList.remove('hidden');
                    userIdEl.textContent = userId;
                    if (unsubscribe) unsubscribe();
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'budgets', 'data');
                    unsubscribe = onSnapshot(docRef, (docSnap) => {
                        transactions = (docSnap.exists() && docSnap.data().transactions) ? docSnap.data().transactions : [];
                        render();
                    });
                } else {
                    userId = null;
                    userInfoEl.classList.add('hidden');
                    if(unsubscribe) unsubscribe();
                    transactions = [];
                    render();
                }
            });

            try { 
                await (typeof __initial_auth_token !== 'undefined' ? signInWithCustomToken(auth, __initial_auth_token) : signInAnonymously(auth)); 
            } catch (e) { console.error("Authentication error", e); }
            
            form.addEventListener('submit', handleFormSubmit);
            cancelEditBtnEl.addEventListener('click', resetForm);
            filterEl.addEventListener('change', render);
            deleteAllBtn.addEventListener('click', deleteAllTransactions);
            downloadBtn.addEventListener('click', handleDownloadImage);
            openCalculatorBtn.addEventListener('click', () => calculatorModal.classList.add('active'));
            calculatorModal.addEventListener('click', (e) => { if (e.target === calculatorModal) calculatorModal.classList.remove('active'); });
            calculatorKeys.addEventListener('click', handleCalculatorInput);
            
            startDateEl.value = today;
            updateDisplay();
        };

        init();
    </script>
</body>
</html>

